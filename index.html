<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Welcome DApp</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.7.0/dist/ethers.umd.min.js"></script>
</head>
<body>
  <h2>Welcome Developers DApp</h2>

  <button id="connect">Connect MetaMask</button>
  <br><br>

  <button id="viewMessage">View Message</button>
  <p><strong>Message from Contract:</strong> <span id="messageDisplay">[Not Fetched]</span></p>

  <hr>

  <input type="text" id="newMessage" placeholder="Enter new message" />
  <button id="setMessage">Set Message</button>
  <p id="statusMsg"></p>

  <script>
    const connectBtn = document.getElementById("connect");
    const viewMessageBtn = document.getElementById("viewMessage");
    const setMessageBtn = document.getElementById("setMessage");
    const messageDisplay = document.getElementById("messageDisplay");
    const statusMsg = document.getElementById("statusMsg");

    const contractAddress = "0xF260dab2c2fF6fACC383884ee93a599B65a9F525";
    const contractABI = [
      "function getMessage() view returns (string)",
      "function setMessage(string memory) public"
    ];

    let provider, signer, contract;

    // Auto-refresh on MetaMask account or network changes
    if (typeof window.ethereum !== "undefined") {
      window.ethereum.on("accountsChanged", (accounts) => {
        console.log("Accounts changed:", accounts);
        window.location.reload();
      });
      window.ethereum.on("chainChanged", (chainId) => {
        console.log("Network changed:", chainId);
        window.location.reload();
      });
      window.ethereum.on("disconnect", (error) => {
        console.log("Disconnected:", error);
        window.location.reload();
      });
    }

    connectBtn.onclick = async () => {
      if (typeof window.ethereum !== "undefined") {
        try {
          await window.ethereum.request({ method: "eth_requestAccounts" });
          provider = new ethers.BrowserProvider(window.ethereum);
          signer = await provider.getSigner();
          const { name, chainId } = await provider.getNetwork();
          console.log(`Connected network: ${name} (chainId: ${chainId})`);
          contract = new ethers.Contract(contractAddress, contractABI, signer);
          console.log("Connected to MetaMask: ", await signer.getAddress());
          alert("Connected to MetaMask!");
        } catch (err) {
          console.error("MetaMask access denied", err);
        }
      } else {
        alert("Please install MetaMask!");
      }
    };

    viewMessageBtn.onclick = async () => {
      if (!contract) return alert("Connect MetaMask first.");
      try {
        const message = await contract.getMessage();
        messageDisplay.innerText = message;
      } catch (err) {
        console.error(err);
        messageDisplay.innerText = "[Error fetching message]";
      }
    };

    setMessageBtn.onclick = async () => {
      if (!contract) return alert("Connect MetaMask first.");
      const newMessage = document.getElementById("newMessage").value;
      if (!newMessage.trim()) return alert("Message cannot be empty.");

      try {
        const tx = await contract.setMessage(newMessage);
        statusMsg.innerText = "Transaction sent. Waiting for confirmation...";
        await tx.wait();
        statusMsg.innerText = "Message updated successfully!";
      } catch (err) {
        console.error(err);
        statusMsg.innerText = "Failed to update message.";
      }
    };
  </script>
</body>
</html>
